service: bandcash
image: peterszarvashu/bandcash

servers:
  - bandcash

proxy:
  host: bandcash.app
  app_port: 2222
  ssl: true
  healthcheck:
    path: /health
    interval: 3
    timeout: 5

registry:
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

builder:
  arch: amd64
  remote: ssh://peti@bandcash
  local: false

ssh:
  user: peti

volumes:
  - bandcash_data:/storage

env:
  clear:
    APP_ENV: production
    PORT: "2222"
    URL: https://bandcash.app
    DB_PATH: /storage/sqlite.db
    LOG_LEVEL: info
    LOG_FOLDER: /storage/logs
    LOG_PREFIX: bandcash
  secret:
    - SMTP_HOST
    - SMTP_PORT
    - SMTP_USERNAME
    - SMTP_PASSWORD
    - EMAIL_FROM

accessories:
  loki:
    service: loki
    image: grafana/loki:3.0.0
    host: bandcash
    cmd: "-config.file=/etc/loki/config.yml"
    port: "127.0.0.1:3100:3100"
    files:
      - config/observability/loki.yml:/etc/loki/config.yml:ro
    directories:
      - loki-data:/loki
    options:
      user: "0"

  promtail:
    service: promtail
    image: grafana/promtail:3.0.0
    host: bandcash
    cmd: "-config.file=/etc/promtail/config.yml"
    files:
      - config/observability/promtail.yml:/etc/promtail/config.yml:ro
    directories:
      - promtail-data:/tmp
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro

  grafana:
    service: grafana
    image: grafana/grafana:11.1.0
    host: bandcash
    port: "127.0.0.1:3000:3000"
    files:
      - config/observability/grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
    directories:
      - grafana-data:/var/lib/grafana
    options:
      user: "0"
    env:
      clear:
        GF_SERVER_ROOT_URL: "http://localhost:3000"
        GF_SECURITY_ADMIN_USER: "admin"
        GF_SECURITY_ADMIN_PASSWORD: "admin"
