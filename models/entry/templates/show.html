{{define "show"}}
<!doctype html>
<html lang="en">
  {{template "head" .}}
  <body>
    <div
      data-signals="{mode: 'single', entryFormState: '', entryFormData: {title: '{{.Entry.Title | js}}', time: '{{.Entry.Time | js}}', description: '{{.Entry.Description | js}}', amount: {{.Entry.Amount}}}, formState: '', editingId: 0, calcPercent: 0, formData: {payeeId: '', payeeName: '', amount: 0, expense: 0}}"
      data-init="@get('/sse')"
    ></div>
    {{block "entry-show" .}}
    <div id="entry-show" class="two-col">
      <main id="app">
        <h1>{{.Title}}</h1>
        {{template "breadcrumbs" .}}

        <h2>Entry Details</h2>

        <div class="entry-details">
          <div class="form-row">
            <div class="field">
              <label>Title</label>
              <p>{{.Entry.Title}}</p>
            </div>
            <div class="field">
              <label>Time</label>
              <p>{{.Entry.Time}}</p>
            </div>
          </div>
          <div class="field">
            <label>Description</label>
            <p>{{.Entry.Description}}</p>
          </div>
          <div class="field">
            <label>Amount</label>
            <p>{{printf "%d" .Entry.Amount}}</p>
          </div>
          <div class="field">
            <label>Leftover</label>
            <p>{{printf "%d" .Leftover}}</p>
          </div>
        </div>

        <h2>Participants</h2>

        <table class="table">
          <thead>
            <tr>
              <th>Payee</th>
              <th>Description</th>
              <th>Cut</th>
              <th>Expense</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {{range .Participants}}
            <tr
              data-payee-id="{{.ID}}"
              data-payee-name="{{.Name}}"
              data-participant-amount="{{.ParticipantAmount}}"
              data-participant-expense="{{.ParticipantExpense}}"
            >
              <td><a href="/payee/{{.ID}}">{{.Name}}</a></td>
              <td>{{.Description}}</td>
              <td class="text-right">{{printf "%d" .ParticipantAmount}}</td>
              <td class="text-right">{{printf "%d" .ParticipantExpense}}</td>
              <td class="text-right">
                {{printf "%d" (add .ParticipantAmount .ParticipantExpense)}}
              </td>
              <td class="text-right">
                <div class="row">
                  <button
                    class="btn"
                    type="button"
                    data-attr:disabled="$formState !== '' || $entryFormState !== ''"
                    data-on:click="$formState = 'edit'; $editingId = {{.ID}}; $formData = {payeeId: Number(el.closest('tr').dataset.payeeId), payeeName: el.closest('tr').dataset.payeeName, amount: Number(el.closest('tr').dataset.participantAmount), expense: Number(el.closest('tr').dataset.participantExpense)}"
                  >
                    Edit
                  </button>
                  <button
                    class="btn"
                    type="button"
                    data-attr:disabled="$formState !== '' || $entryFormState !== ''"
                    data-on:click="if (window.confirm('Delete this participant?')) { @delete('/entry/{{$.Entry.ID}}/participant/{{.ID}}') }"
                  >
                    Delete
                  </button>
                </div>
              </td>
            </tr>
            {{else}}
            <tr>
              <td colspan="6">no items</td>
            </tr>
            {{end}}
          </tbody>
        </table>
      </main>
      <aside class="sidebar-panel">
        <div data-show="$entryFormState === '' && $formState === ''">
          <div class="pb">
            <h3>Entry Actions</h3>
            <div class="row">
              <button
                class="btn"
                type="button"
              data-on:click="$entryFormState = 'edit'; $errors = {title: '', time: '', description: '', amount: ''}"
              >
                Edit Entry
              </button>
              <button
                class="btn"
                type="button"
                data-on:click="if (window.confirm('Delete this entry?')) { @delete('/entry/{{.Entry.ID}}') }"
              >
                Delete Entry
              </button>
            </div>
          </div>
          <div class="pb">
            <h3>Add Participant</h3>
            <div class="row">
              <button
                class="btn"
                type="button"
                data-on:click="$formState = 'add'; $editingId = 0; $calcPercent = 0; $formData = {payeeId: 0, payeeName: '', amount: 0, expense: 0}; $errors = {payeeId: '', amount: '', expense: ''}"
              >
                Add Participant
              </button>
            </div>
          </div>
        </div>

        <div data-show="$entryFormState === 'edit'" style="display: none" class="pb">
          <h3>Edit Entry</h3>
          <form class="form">
            <div class="form-row">
              <div class="field">
                <label>Title</label>
                <input type="text" data-bind="entryFormData.title" />
                <div
                  data-show="$errors && $errors.title"
                  class="color-error"
                  data-text="$errors.title"
                ></div>
              </div>
              <div class="field">
                <label>Time</label>
                <input type="datetime-local" data-bind="entryFormData.time" />
                <div
                  data-show="$errors && $errors.time"
                  class="color-error"
                  data-text="$errors.time"
                ></div>
              </div>
            </div>
            <div class="field">
              <label>Description</label>
              <textarea data-bind="entryFormData.description" rows="3"></textarea>
              <div
                data-show="$errors && $errors.description"
                class="color-error"
                data-text="$errors.description"
              ></div>
            </div>
            <div class="field">
              <label>Amount</label>
              <input type="number" data-bind="entryFormData.amount" step="1" />
              <div
                data-show="$errors && $errors.amount"
                class="color-error"
                data-text="$errors.amount"
              ></div>
            </div>
            <div class="row">
              <button
                class="btn"
                type="button"
                data-on:click="@put('/entry/{{.Entry.ID}}')"
              >
                Update Entry
              </button>
              <button
                class="btn"
                type="button"
                data-on:click="$entryFormState = ''; $entryFormData = {title: '{{.Entry.Title | js}}', time: '{{.Entry.Time | js}}', description: '{{.Entry.Description | js}}', amount: {{.Entry.Amount}}}; $errors = {title: '', time: '', description: '', amount: ''}"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>

        <div data-show="$formState !== '' && $entryFormState === ''" style="display: none" class="pb">
          <h3 data-show="$formState === 'add'">New Participant</h3>
          <h3 data-show="$formState === 'edit'">Edit Participant</h3>
          <form class="form">
            <div data-show="$formState === 'add'">
              <label>Payee</label>
              <select data-bind="formData.payeeId">
                <option value="">Select payee</option>
                {{range .Payees}}
                <option value="{{.ID}}">{{.Name}}</option>
                {{end}}
              </select>
              <div
                data-show="$errors && $errors.payeeId"
                class="color-error"
                data-text="$errors.payeeId"
              ></div>
            </div>
            <div data-show="$formState === 'edit'">
              <label>Payee</label>
              <input type="text" data-bind="formData.payeeName" disabled />
            </div>
            <div>
              <label>Cut Amount</label>
              <div class="row">
                <input
                  type="number"
                  data-bind="formData.amount"
                  step="1"
                  style="flex: 1"
                />
                <button
                  class="btn"
                  type="button"
                  data-on:click="$calcPercent = $formData.amount > 0 ? Math.round($formData.amount / {{.Entry.Amount}} * 10000) / 100 : 0"
                >
                  Calc %
                </button>
              </div>
              <div
                data-show="$errors && $errors.amount"
                class="color-error"
                data-text="$errors.amount"
              ></div>
            </div>
            <div>
              <label>Quick Calc (% of entry)</label>
              <div class="row">
                <input
                  type="number"
                  data-bind="calcPercent"
                  step="0.01"
                  min="0"
                  placeholder="e.g., 20"
                  style="flex: 1"
                />
                <button
                  class="btn"
                  type="button"
                  data-on:click="$formData.amount = Math.round({{.Entry.Amount}} * $calcPercent / 100)"
                >
                  Calc Amount
                </button>
              </div>
            </div>
            <div>
              <label>Expense</label>
              <input type="number" data-bind="formData.expense" step="1" />
              <div
                data-show="$errors && $errors.expense"
                class="color-error"
                data-text="$errors.expense"
              ></div>
            </div>
            <div style="font-weight: bold; padding: 10px 0">
              <strong>Total:</strong>
              <span data-text="$formData.amount + $formData.expense"></span>
            </div>
            <div class="row">
              <button
                class="btn"
                type="button"
                data-show="$formState === 'add'"
                data-on:click="@post('/entry/{{$.Entry.ID}}/participant')"
              >
                Add Participant
              </button>
              <button
                class="btn"
                type="button"
                data-show="$formState === 'edit'"
                data-on:click="@put('/entry/{{$.Entry.ID}}/participant/' + $editingId)"
              >
                Update Participant
              </button>
              <button
                class="btn"
                type="button"
                data-on:click="$formState = ''; $editingId = 0; $calcPercent = 0; $formData = {payeeId: 0, payeeName: '', amount: 0, expense: 0}; $errors = {payeeId: '', amount: '', expense: ''}"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </aside>
    </div>
    {{end}}
  </body>
</html>
{{end}}
