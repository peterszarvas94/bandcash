package dev

import (
	appi18n "bandcash/internal/i18n"
	"bandcash/internal/utils"
	shared "bandcash/models/shared"
	icons "bandcash/models/shared/icons"
)

templ DevPage() {
	<!DOCTYPE html>
	<html lang={ appi18n.LocaleCode(ctx) }>
		@shared.Head("Dev tools")
		<body>
			<div data-signals={ templ.JSONString(map[string]any{"csrf": utils.CSRFToken(ctx), "errors": map[string]any{"name": ""}, "formData": map[string]any{"name": ""}, "_fetching": false, "activeSpinner": "", "_notifyInline": false, "_notifyInfo": false, "_notifySuccess": false, "_notifyWarning": false, "_notifyError": false}) } data-init="@get('/sse')"></div>
			@shared.Notifications()
			@shared.AppShellMainOnly("dev-page", []utils.Crumb{{Label: "Dev tools"}}, "", shared.DevPrimaryNav("dev"), DevMain())
		</body>
	</html>
}

templ DevMain() {
	@shared.Section("Notifications", NotificationsContent())
	@shared.Section("Email previews", EmailPreviewContent())
	@shared.Section("Loading indicator test", LoadingIndicatorContent())
	@shared.Section("Table query tests", TableQueryTestContent())
	@shared.Section("Rate limit", RateLimitContent())
	@shared.Section("Body limit", BodyLimitContent())
}

templ TableQueryTestContent() {
	<p>Run hardcoded query examples and inspect parsed + backend response.</p>
	<div class="row row-wrap">
		@shared.IDActionButton("query-test-events-valid", "btn btn-info", "Events valid query")
		@shared.IDActionButton("query-test-events-invalid", "btn btn-warning", "Events invalid values")
		@shared.IDActionButton("query-test-members-valid", "btn btn-success", "Members valid query")
		@shared.IDActionButton("query-test-expenses-valid", "btn btn-primary", "Expenses valid query")
	</div>
	<pre id="query-test-output">Ready.</pre>
}

templ EmailPreviewContent() {
	<p>Open email previews in a new tab (no app shell, only raw email content):</p>
	<div class="row row-wrap">
		<a class="btn" href="/dev/emails/login" target="_blank" rel="noopener">Login email</a>
		<a class="btn" href="/dev/emails/invite" target="_blank" rel="noopener">Invite email</a>
	</div>
}

templ LoadingIndicatorContent() {
	<div class="row row-wrap">
		<form data-on:submit="@post('/dev/spinner')" data-indicator:_fetching>
			<button class="btn btn-primary" type="submit" data-on:click="$activeSpinner = 'request'" data-attr:disabled="$_fetching">
				<span data-show="$_fetching && $activeSpinner === 'request'" style="display: none">
					@icons.LoaderCircle(templ.Attributes{"class": "icon icon-spin"})
				</span>
				<span data-show="!($_fetching && $activeSpinner === 'request')">
					@icons.Play(templ.Attributes{"class": "icon"})
				</span>
				<span>Spinner 500ms</span>
			</button>
		</form>
		<form data-on:submit="@post('/dev/spinner?ms=750')" data-indicator:_fetching>
			<button class="btn" type="submit" data-on:click="$activeSpinner = 'quick'" data-attr:disabled="$_fetching">
				<span data-show="$_fetching && $activeSpinner === 'quick'" style="display: none">
					@icons.LoaderCircle(templ.Attributes{"class": "icon icon-spin"})
				</span>
				<span data-show="!($_fetching && $activeSpinner === 'quick')">
					@icons.Play(templ.Attributes{"class": "icon"})
				</span>
				<span>Spinner 750ms</span>
			</button>
		</form>
		<form data-on:submit="@post('/dev/spinner?ms=3000')" data-indicator:_fetching>
			<button class="btn" type="submit" data-on:click="$activeSpinner = 'slow'" data-attr:disabled="$_fetching">
				<span data-show="$_fetching && $activeSpinner === 'slow'" style="display: none">
					@icons.LoaderCircle(templ.Attributes{"class": "icon icon-spin"})
				</span>
				<span data-show="!($_fetching && $activeSpinner === 'slow')">
					@icons.Play(templ.Attributes{"class": "icon"})
				</span>
				<span>Spinner 3000ms</span>
			</button>
		</form>
	</div>
}

templ NotificationsContent() {
	<form class="form" data-on:submit="@post('/dev/notifications/inline')" data-indicator:_notifyInline>
		<div class="field">
			<label>Required field</label>
			<div class="row">
				<input type="text" data-bind="formData.name" placeholder="Type anything"/>
				@shared.LoadingSubmitButtonWithSignal("btn btn-primary", "Inline validation", icons.IconSave, "_notifyInline")
			</div>
			<div data-show="$errors && $errors.name" class="color-error" data-text="$errors.name"></div>
		</div>
	</form>
	<div class="row row-wrap">
		@shared.LoadingActionButtonWithSignal("btn btn-info", "@post('/dev/notifications/info')", "$_notifyInfo", "Info", icons.IconInfo, "_notifyInfo")
		@shared.LoadingActionButtonWithSignal("btn btn-success", "@post('/dev/notifications/success')", "$_notifySuccess", "Success", icons.IconCheck, "_notifySuccess")
		@shared.LoadingActionButtonWithSignal("btn btn-warning", "@post('/dev/notifications/warning')", "$_notifyWarning", "Warning", icons.IconTriangleAlert, "_notifyWarning")
		@shared.LoadingActionButtonWithSignal("btn btn-danger", "@post('/dev/notifications/error')", "$_notifyError", "Error", icons.IconCircleX, "_notifyError")
	</div>
}

templ RateLimitContent() {
	<p>Fire repeated requests to inspect rate-limit behavior from the browser.</p>
	<div class="row row-wrap">
		@shared.IDActionButton("spam-health", "btn btn-info", "Spam /health")
		@shared.IDActionButton("spam-auth", "btn btn-warning", "Spam /auth/login")
	</div>
	<input id="rate-limit-csrf" type="hidden" value={ utils.CSRFToken(ctx) }/>
	<span id="rate-limit-msg-start-health" hidden>Running /health burst...</span>
	<span id="rate-limit-msg-done-health" hidden>/health burst completed.</span>
	<span id="rate-limit-msg-start-auth" hidden>Running /auth/login burst...</span>
	<span id="rate-limit-msg-done-auth" hidden>/auth/login burst completed.</span>
	<pre id="rate-limit-output">Ready.</pre>
}

templ BodyLimitContent() {
	<p>Send small and oversized payloads to verify body-size limits.</p>
	<div class="row row-wrap">
		@shared.IDActionButton("body-limit-global-ok", "btn btn-success", "POST /health (small body)")
		@shared.IDActionButton("body-limit-global-big", "btn btn-danger", "POST /health (too large)")
		@shared.IDActionButton("body-limit-auth-ok", "btn btn-info", "POST /auth/login (small body)")
		@shared.IDActionButton("body-limit-auth-big", "btn btn-danger", "POST /auth/login (too large)")
	</div>
	<input id="body-limit-csrf" type="hidden" value={ utils.CSRFToken(ctx) }/>
	<span id="body-limit-msg-global-ok" hidden>Sending small payload to /health...</span>
	<span id="body-limit-msg-global-big" hidden>Sending oversized payload to /health...</span>
	<span id="body-limit-msg-auth-ok" hidden>Sending small payload to /auth/login...</span>
	<span id="body-limit-msg-auth-big" hidden>Sending oversized payload to /auth/login...</span>
	<span id="body-limit-msg-result" hidden>Result:</span>
	<pre id="body-limit-output">Ready.</pre>
}
