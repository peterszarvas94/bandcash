package dev

import (
	ctxi18n "github.com/invopop/ctxi18n/i18n"

	appi18n "bandcash/internal/i18n"
	"bandcash/internal/utils"
	shared "bandcash/models/shared"
	icons "bandcash/models/shared/icons"
)

templ DevPage() {
	<!DOCTYPE html>
	<html lang={ appi18n.LocaleCode(ctx) }>
		@shared.Head(ctxi18n.T(ctx, "dev.title"))
		<body>
			<div data-signals={ templ.JSONString(map[string]any{"csrf": utils.CSRFToken(ctx), "errors": map[string]any{"name": ""}, "formData": map[string]any{"name": ""}, "_fetching": false, "activeSpinner": "", "_notifyInline": false, "_notifyInfo": false, "_notifySuccess": false, "_notifyWarning": false, "_notifyError": false}) } data-init="@get('/sse')"></div>
			@shared.Notifications()
			@shared.AppShellMainOnly("dev-page", []utils.Crumb{{Label: ctxi18n.T(ctx, "dev.title")}}, "", shared.DevPrimaryNav("dev"), DevMain())
		</body>
	</html>
}

templ DevMain() {
	@shared.Section(ctxi18n.T(ctx, "dev.notifications.title"), NotificationsContent())
	@shared.Section("Email previews", EmailPreviewContent())
	@shared.Section("Loading indicator test", LoadingIndicatorContent())
	@shared.Section(ctxi18n.T(ctx, "dev.ratelimit.title"), RateLimitContent())
	@shared.Section(ctxi18n.T(ctx, "dev.bodylimit.title"), BodyLimitContent())
}

templ EmailPreviewContent() {
	<p>Open email previews in a new tab (no app shell, only raw email content):</p>
	<div class="row row-wrap">
		<a class="btn" href="/dev/emails/login" target="_blank" rel="noopener">Login email</a>
		<a class="btn" href="/dev/emails/invite" target="_blank" rel="noopener">Invite email</a>
	</div>
}

templ LoadingIndicatorContent() {
	<div class="row row-wrap">
		<form data-on:submit="@post('/dev/spinner')" data-indicator:_fetching>
			<button class="btn btn-primary" type="submit" data-on:click="$activeSpinner = 'request'" data-attr:disabled="$_fetching">
				<span data-show="$_fetching && $activeSpinner === 'request'" style="display: none">
					@icons.LoaderCircle(templ.Attributes{"class": "icon icon-spin"})
				</span>
				<span data-show="!($_fetching && $activeSpinner === 'request')">
					@icons.Play(templ.Attributes{"class": "icon"})
				</span>
				<span>Spinner 500ms</span>
			</button>
		</form>
		<form data-on:submit="@post('/dev/spinner?ms=750')" data-indicator:_fetching>
			<button class="btn" type="submit" data-on:click="$activeSpinner = 'quick'" data-attr:disabled="$_fetching">
				<span data-show="$_fetching && $activeSpinner === 'quick'" style="display: none">
					@icons.LoaderCircle(templ.Attributes{"class": "icon icon-spin"})
				</span>
				<span data-show="!($_fetching && $activeSpinner === 'quick')">
					@icons.Play(templ.Attributes{"class": "icon"})
				</span>
				<span>Spinner 750ms</span>
			</button>
		</form>
		<form data-on:submit="@post('/dev/spinner?ms=3000')" data-indicator:_fetching>
			<button class="btn" type="submit" data-on:click="$activeSpinner = 'slow'" data-attr:disabled="$_fetching">
				<span data-show="$_fetching && $activeSpinner === 'slow'" style="display: none">
					@icons.LoaderCircle(templ.Attributes{"class": "icon icon-spin"})
				</span>
				<span data-show="!($_fetching && $activeSpinner === 'slow')">
					@icons.Play(templ.Attributes{"class": "icon"})
				</span>
				<span>Spinner 3000ms</span>
			</button>
		</form>
	</div>
}

templ NotificationsContent() {
	<form class="form" data-on:submit="@post('/dev/notifications/inline')" data-indicator:_notifyInline>
		<div class="field">
			<label>{ ctxi18n.T(ctx, "dev.notifications.required_field") }</label>
			<div class="row">
				<input type="text" data-bind="formData.name" placeholder={ ctxi18n.T(ctx, "dev.notifications.type_anything") }/>
				@shared.LoadingSubmitButtonWithSignal("btn btn-primary", ctxi18n.T(ctx, "dev.notifications.submit_inline"), icons.IconSave, "_notifyInline")
			</div>
			<div data-show="$errors && $errors.name" class="color-error" data-text="$errors.name"></div>
		</div>
	</form>
	<div class="row row-wrap">
		@shared.LoadingActionButtonWithSignal("btn btn-info", "@post('/dev/notifications/info')", "$_notifyInfo", ctxi18n.T(ctx, "dev.notifications.info"), icons.IconInfo, "_notifyInfo")
		@shared.LoadingActionButtonWithSignal("btn btn-success", "@post('/dev/notifications/success')", "$_notifySuccess", ctxi18n.T(ctx, "dev.notifications.success"), icons.IconCheck, "_notifySuccess")
		@shared.LoadingActionButtonWithSignal("btn btn-warning", "@post('/dev/notifications/warning')", "$_notifyWarning", ctxi18n.T(ctx, "dev.notifications.warning"), icons.IconTriangleAlert, "_notifyWarning")
		@shared.LoadingActionButtonWithSignal("btn btn-danger", "@post('/dev/notifications/error')", "$_notifyError", ctxi18n.T(ctx, "dev.notifications.error"), icons.IconCircleX, "_notifyError")
	</div>
}

templ RateLimitContent() {
	<p>{ ctxi18n.T(ctx, "dev.ratelimit.description") }</p>
	<div class="row row-wrap">
		@shared.IDActionButton("spam-health", "btn btn-info", ctxi18n.T(ctx, "dev.ratelimit.spam_health"))
		@shared.IDActionButton("spam-auth", "btn btn-warning", ctxi18n.T(ctx, "dev.ratelimit.spam_auth"))
	</div>
	<input id="rate-limit-csrf" type="hidden" value={ utils.CSRFToken(ctx) }/>
	<span id="rate-limit-msg-start-health" hidden>{ ctxi18n.T(ctx, "dev.ratelimit.start_health") }</span>
	<span id="rate-limit-msg-done-health" hidden>{ ctxi18n.T(ctx, "dev.ratelimit.done_health") }</span>
	<span id="rate-limit-msg-start-auth" hidden>{ ctxi18n.T(ctx, "dev.ratelimit.start_auth") }</span>
	<span id="rate-limit-msg-done-auth" hidden>{ ctxi18n.T(ctx, "dev.ratelimit.done_auth") }</span>
	<pre id="rate-limit-output">{ ctxi18n.T(ctx, "dev.ratelimit.ready") }</pre>
}

templ BodyLimitContent() {
	<p>{ ctxi18n.T(ctx, "dev.bodylimit.description") }</p>
	<div class="row row-wrap">
		@shared.IDActionButton("body-limit-global-ok", "btn btn-success", ctxi18n.T(ctx, "dev.bodylimit.global_ok"))
		@shared.IDActionButton("body-limit-global-big", "btn btn-danger", ctxi18n.T(ctx, "dev.bodylimit.global_big"))
		@shared.IDActionButton("body-limit-auth-ok", "btn btn-info", ctxi18n.T(ctx, "dev.bodylimit.auth_ok"))
		@shared.IDActionButton("body-limit-auth-big", "btn btn-danger", ctxi18n.T(ctx, "dev.bodylimit.auth_big"))
	</div>
	<input id="body-limit-csrf" type="hidden" value={ utils.CSRFToken(ctx) }/>
	<span id="body-limit-msg-global-ok" hidden>{ ctxi18n.T(ctx, "dev.bodylimit.msg_global_ok") }</span>
	<span id="body-limit-msg-global-big" hidden>{ ctxi18n.T(ctx, "dev.bodylimit.msg_global_big") }</span>
	<span id="body-limit-msg-auth-ok" hidden>{ ctxi18n.T(ctx, "dev.bodylimit.msg_auth_ok") }</span>
	<span id="body-limit-msg-auth-big" hidden>{ ctxi18n.T(ctx, "dev.bodylimit.msg_auth_big") }</span>
	<span id="body-limit-msg-result" hidden>{ ctxi18n.T(ctx, "dev.bodylimit.msg_result") }</span>
	<pre id="body-limit-output">{ ctxi18n.T(ctx, "dev.bodylimit.ready") }</pre>
}
