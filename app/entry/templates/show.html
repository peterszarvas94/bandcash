{{define "show"}}
<!doctype html>
<html lang="en">
  {{template "head" .}}
  <body>
    <div
      data-signals="{view: '/entry/{{.Entry.ID}}', editingEntry: false, editingPayeeId: 0, editAmount: '', addingParticipant: false, newPayeeId: '', newAmount: ''}"
      data-init="@get('/sse')"
    ></div>
    {{block "app" .}}
    <main id="app">
      <h1>{{.Title}}</h1>
      {{template "breadcrumbs" .}}

      <div class="entry-details" data-show="!$editingEntry">
        <p><strong>Title:</strong> {{.Entry.Title}}</p>
        <p><strong>Time:</strong> {{.Entry.Time}}</p>
        <p><strong>Description:</strong> {{.Entry.Description}}</p>
        <p><strong>Amount:</strong> {{printf "%d" .Entry.Amount}}</p>
      </div>

      <div data-show="$editingEntry" style="display: none;">
        <form
          class="form"
          data-on:submit="@put('/entry/{{.Entry.ID}}')"
        >
          <div>
            <label>Title</label>
            <input
              type="text"
              name="title"
              data-bind="title"
              value="{{.Entry.Title}}"
              required
            />
          </div>
          <div>
            <label>Time</label>
            <input
              type="datetime-local"
              name="time"
              data-bind="time"
              value="{{.Entry.Time}}"
              required
            />
          </div>
          <div>
            <label>Description</label>
            <textarea name="description" data-bind="description" rows="3">
{{.Entry.Description}}</textarea
            >
          </div>
          <div>
            <label>Amount</label>
            <input
              type="number"
              name="amount"
              data-bind="amount"
              value="{{.Entry.Amount}}"
              step="1"
              required
            />
          </div>
          <div class="row">
            <button type="submit">Update Entry</button>
            <button
              type="button"
              data-on:click="window.location.href = '/entry/{{.Entry.ID}}'"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>

      <p class="row">
        <a href="/entry/{{.Entry.ID}}/edit">Edit</a>
        <button
          data-on:click="if (window.confirm('Delete this entry?')) { @delete('/entry/{{.Entry.ID}}') }"
        >
          Delete
        </button>
      </p>

      <h2>Participants</h2>
      <table class="table">
        <thead>
          <tr>
            <th>Payee</th>
            <th>Description</th>
            <th>Amount</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {{range .Participants}}
          <tr data-show="$editingPayeeId !== {{.ID}}" style="display: none;">
            <td><a href="/payee/{{.ID}}">{{.Name}}</a></td>
            <td>{{.Description}}</td>
            <td class="text-right">{{printf "%d" .ParticipantAmount}}</td>
            <td class="text-right">
              <button
                type="button"
                data-on:click="$editingPayeeId = {{.ID}}; $editAmount = '{{printf "%d" .ParticipantAmount}}'"
                data-show="!$addingParticipant"
              >
                Edit
              </button>
              <button
                type="button"
                data-on:click="if (window.confirm('Delete this participant?')) { @delete('/entry/{{$.Entry.ID}}/participants/{{.ID}}') }"
                data-show="!$addingParticipant"
              >
                Delete
              </button>
            </td>
          </tr>
          <tr data-show="$editingPayeeId === {{.ID}}" style="display: none;">
            <td><a href="/payee/{{.ID}}">{{.Name}}</a></td>
            <td>{{.Description}}</td>
            <td class="text-right">
              <input
                type="number"
                name="amount"
                data-bind="editAmount"
                step="1"
                required
              />
            </td>
            <td class="text-right">
              <button
                type="button"
                data-on:click="@put('/entry/{{$.Entry.ID}}/participants/{{.ID}}')"
              >
                Save
              </button>
              <button
                type="button"
                data-on:click="$editingPayeeId = 0; $editAmount = ''"
              >
                Cancel
              </button>
            </td>
          </tr>
          {{end}}
          <tr data-show="$addingParticipant" style="display: none;">
            <td>
              <select name="payee_id" data-bind="newPayeeId" required>
                <option value="">Select payee</option>
                {{range .Payees}}
                <option value="{{.ID}}">{{.Name}}</option>
                {{end}}
              </select>
            </td>
            <td></td>
            <td class="text-right">
              <input
                type="number"
                name="amount"
                data-bind="newAmount"
                step="1"
                required
              />
            </td>
            <td class="text-right">
              <button type="button" data-on:click="@post('/entry/{{$.Entry.ID}}/participants')">
                Add
              </button>
              <button
                type="button"
                data-on:click="$addingParticipant = false; $newPayeeId = ''; $newAmount = ''"
              >
                Cancel
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <p
        class="row"
        data-show="!$addingParticipant && $editingPayeeId === 0"
      >
        <button type="button" data-on:click="$addingParticipant = true">
          Add participant
        </button>
      </p>

    </main>
    {{end}}
  </body>
</html>
{{end}}
