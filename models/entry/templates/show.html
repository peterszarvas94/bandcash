{{define "show"}}
<!doctype html>
<html lang="en">
  {{template "head" .}}
  <body>
    <div
      data-signals="{mode: 'single', formState: '', editingId: 0, calcPercent: 0, formData: {payeeId: '', payeeName: '', amount: 0, expense: 0}}"
      data-init="@get('/sse')"
    ></div>
    {{block "entry-show" .}}
    <main id="app">
      <h1>{{.Title}}</h1>
      {{template "breadcrumbs" .}}

      <div class="entry-details">
        <p><strong>Title:</strong> {{.Entry.Title}}</p>
        <p><strong>Time:</strong> {{.Entry.Time}}</p>
        <p><strong>Description:</strong> {{.Entry.Description}}</p>
        <p><strong>Amount:</strong> {{printf "%d" .Entry.Amount}}</p>
        <p><strong>Leftover (taxes):</strong> {{printf "%d" .Leftover}}</p>
      </div>

      <p class="row">
        <a href="/entry/{{.Entry.ID}}/edit">Edit</a>
        <button
          data-on:click="if (window.confirm('Delete this entry?')) { @delete('/entry/{{.Entry.ID}}') }"
        >
          Delete
        </button>
      </p>

      <h2>Participants</h2>

      <div data-show="$formState === ''" class="row pb">
        <button
          type="button"
          data-on:click="$formState = 'add'; $editingId = 0; $calcPercent = 0; $formData = {payeeId: 0, payeeName: '', amount: 0, expense: 0}; $errors = {payeeId: '', amount: '', expense: ''}"
        >
          Add Participant
        </button>
      </div>

      <div data-show="$formState !== ''" style="display: none" class="pb">
        <h3 data-show="$formState === 'add'">New Participant</h3>
        <h3 data-show="$formState === 'edit'">Edit Participant</h3>
        <form class="form">
          <div data-show="$formState === 'add'">
            <label>Payee</label>
            <select data-bind="formData.payeeId">
              <option value="">Select payee</option>
              {{range .Payees}}
              <option value="{{.ID}}">{{.Name}}</option>
              {{end}}
            </select>
            <div
              data-show="$errors && $errors.payeeId"
              class="color-error"
              data-text="$errors.payeeId"
            ></div>
          </div>
          <div data-show="$formState === 'edit'">
            <label>Payee</label>
            <input type="text" data-bind="formData.payeeName" disabled />
          </div>
          <div>
            <label>Cut Amount</label>
            <input
              type="number"
              data-bind="formData.amount"
              step="1"
            />
            <div
              data-show="$errors && $errors.amount"
              class="color-error"
              data-text="$errors.amount"
            ></div>
          </div>
          <div>
            <label>Quick Calc (% of entry)</label>
            <div class="row">
              <input
                type="number"
                data-bind="calcPercent"
                step="0.01"
                min="0"
                placeholder="e.g., 20"
                style="flex: 1"
              />
              <button
                type="button"
                data-on:click="$formData.amount = Math.round({{.Entry.Amount}} * $calcPercent / 100)"
              >
                Calculate
              </button>
            </div>
          </div>
          <div>
            <label>Expense</label>
            <input type="number" data-bind="formData.expense" step="1" />
            <div
              data-show="$errors && $errors.expense"
              class="color-error"
              data-text="$errors.expense"
            ></div>
          </div>
          <div style="font-weight: bold; padding: 10px 0">
            <strong>Total:</strong>
            <span data-text="$formData.amount + $formData.expense"></span>
          </div>
          <div class="row">
            <button
              type="button"
              data-show="$formState === 'add'"
              data-on:click="@post('/entry/{{$.Entry.ID}}/participant')"
            >
              Add Participant
            </button>
            <button
              type="button"
              data-show="$formState === 'edit'"
              data-on:click="@put('/entry/{{$.Entry.ID}}/participant/' + $editingId)"
            >
              Update Participant
            </button>
            <button
              type="button"
              data-on:click="$formState = ''; $editingId = 0; $calcPercent = 0; $formData = {payeeId: 0, payeeName: '', amount: 0, expense: 0}; $errors = {payeeId: '', amount: '', expense: ''}"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Payee</th>
            <th>Description</th>
            <th>Cut</th>
            <th>Expense</th>
            <th>Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {{range .Participants}}
          <tr
            data-payee-id="{{.ID}}"
            data-payee-name="{{.Name}}"
            data-participant-amount="{{.ParticipantAmount}}"
            data-participant-expense="{{.ParticipantExpense}}"
          >
            <td><a href="/payee/{{.ID}}">{{.Name}}</a></td>
            <td>{{.Description}}</td>
            <td class="text-right">{{printf "%d" .ParticipantAmount}}</td>
            <td class="text-right">{{printf "%d" .ParticipantExpense}}</td>
            <td class="text-right">
              {{printf "%d" (add .ParticipantAmount .ParticipantExpense)}}
            </td>
            <td class="text-right">
              <div class="row" data-show="$formState === ''">
                <button
                  type="button"
                  data-on:click="$formState = 'edit'; $editingId = {{.ID}}; $formData = {payeeId: Number(el.closest('tr').dataset.payeeId), payeeName: el.closest('tr').dataset.payeeName, amount: Number(el.closest('tr').dataset.participantAmount), expense: Number(el.closest('tr').dataset.participantExpense)}"
                >
                  Edit
                </button>
                <button
                  type="button"
                  data-on:click="if (window.confirm('Delete this participant?')) { @delete('/entry/{{$.Entry.ID}}/participant/{{.ID}}') }"
                >
                  Delete
                </button>
              </div>
            </td>
          </tr>
          {{else}}
          <tr>
            <td colspan="6">no items</td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </main>
    {{end}}
  </body>
</html>
{{end}}
